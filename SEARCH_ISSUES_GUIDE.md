# 搜尋相關度問題診斷指南

## 問題現象
搜尋結果顯示高相關度（例如 0.8-0.9），但實際上內容不相關。

## 可能原因

### 1. 向量嵌入問題
Gemini 的 `text-embedding-004` 模型可能對某些中文法律術語的語義理解不夠精確。

### 2. Pinecone 索引問題
- 索引中可能有重複的向量
- 或者索引損壞

### 3. 搜尋查詢問題
- 查詢詞太短或太模糊
- 查詢詞與筆記內容的語義差距大

## 診斷步驟

### 步驟 1：檢查 Pinecone 索引狀態

1. 登入 Pinecone Dashboard: https://www.pinecone.io/
2. 查看 `legal-exam` 索引
3. 檢查：
   - Vector Count（向量數量）
   - Dimension（維度，應該是 768）
   - 是否有異常

### 步驟 2：測試搜尋並查看終端機輸出

執行搜尋時，終端機會顯示：
```
🔍 Pinecone 返回 X 個結果
  結果 1: 分數 0.XXX
  結果 2: 分數 0.XXX
✅ 過濾後找到 X 個相關結果（閾值 >= 0.6）
```

**觀察**：
- 如果所有結果分數都很高（> 0.8）但不相關 → 可能是嵌入模型問題
- 如果分數分布正常但結果不對 → 可能是索引問題

### 步驟 3：檢查筆記內容

查看返回的筆記內容，確認：
- 筆記是否真的與查詢無關
- 或者是語義上有關聯但不是您期望的

## 解決方案

### 方案 A：清空並重建 Pinecone 索引

如果懷疑索引損壞或有重複：

```python
# 在 Python 中執行
from pinecone import Pinecone
from config import Config

pc = Pinecone(api_key=Config.PINECONE_API_KEY)
index = pc.Index(Config.PINECONE_INDEX_NAME)

# 刪除所有向量
index.delete(delete_all=True)

# 重新匯入
python import_notes_to_pinecone.py
```

### 方案 B：調整搜尋策略

1. **提高閾值**（目前 0.6）
   - 改為 0.7 或 0.8
   - 只顯示非常相關的結果

2. **增加搜尋結果數量**
   - 讓 Pinecone 返回更多結果
   - 從中篩選最相關的

3. **改用混合搜尋**
   - 結合關鍵字搜尋和語義搜尋
   - 提高準確度

### 方案 C：更換嵌入模型

如果 Gemini 的嵌入效果不好，可以考慮：
- OpenAI 的 `text-embedding-3-small`
- 或其他專門針對中文的嵌入模型

## 測試建議

1. **測試特定查詢**
   - 搜尋：「侵權行為」
   - 預期：應該找到包含侵權行為相關內容的筆記
   - 實際：記錄返回的筆記標題和分數

2. **測試不同長度的查詢**
   - 短查詢：「民法」
   - 長查詢：「民法中關於侵權行為的構成要件有哪些？」
   - 比較哪種效果更好

3. **查看原始筆記**
   - 到 Airtable 查看實際筆記內容
   - 確認筆記內容是否真的與查詢相關

## 需要協助

如果需要我幫您：
1. 清空並重建 Pinecone 索引
2. 調整搜尋閾值
3. 實作混合搜尋
4. 更換嵌入模型

請告訴我您想嘗試哪個方案！
